import React, { useState, useEffect, useMemo, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  deleteDoc, 
  doc, 
  onSnapshot
} from 'firebase/firestore';
import { 
  Plus, 
  Calendar as CalendarIcon, 
  MapPin, 
  Trash2, 
  ChevronLeft, 
  ChevronRight,
  FileText,
  Wallet,
  Receipt,
  Image as ImageIcon,
  FileDown,
  TrendingUp,
  CreditCard,
  Clock,
  Camera,
  X,
  Eye,
  Loader2,
  CheckCircle2
} from 'lucide-react';

// --- Configuración e Inicialización de Firebase ---
// Estas variables las inyecta el entorno automáticamente
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// Helper para cargar scripts externos (PDF e Imagen)
const loadScript = (src) => {
  return new Promise((resolve) => {
    const script = document.createElement('script');
    script.src = src;
    script.onload = () => resolve(true);
    script.onerror = () => resolve(false);
    document.head.appendChild(script);
  });
};

const App = () => {
  // --- Estados de Auth y Carga ---
  const [user, setUser] = useState(null);
  const [loadingAuth, setLoadingAuth] = useState(true);
  const [isSyncing, setIsSyncing] = useState(true);

  // --- Estados de Datos ---
  const [entries, setEntries] = useState([]);
  const [expenses, setExpenses] = useState([]);
  const [activeTab, setActiveTab] = useState('trips'); 
  const [viewMonth, setViewMonth] = useState(new Date());
  const [previewImage, setPreviewImage] = useState(null);
  
  const reportRef = useRef(null);
  const fileInputRef = useRef(null);

  // --- Estados de Formularios ---
  const [routeName, setRouteName] = useState('');
  const [destination, setDestination] = useState('Santiago');
  const [tripDate, setTripDate] = useState(new Date().toISOString().split('T')[0]);
  const [startTime, setStartTime] = useState('');
  const [endTime, setEndTime] = useState('');
  const [expDescription, setExpDescription] = useState('');
  const [expAmount, setExpAmount] = useState('');
  const [expCategory, setExpCategory] = useState('Peaje');
  const [expDate, setExpDate] = useState(new Date().toISOString().split('T')[0]);
  const [expReceipt, setExpReceipt] = useState(null);

  // --- EFECTO 1: Autenticación (Regla 3) ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Error al autenticar:", error);
      } finally {
        setLoadingAuth(false);
      }
    };
    initAuth();

    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
    });
    return () => unsubscribe();
  }, []);

  // --- EFECTO 2: Sincronización Firestore (Regla 1) ---
  useEffect(() => {
    if (!user) return;

    // Rutas estrictas según Regla 1
    const tripsPath = collection(db, 'artifacts', appId, 'public', 'data', 'trips');
    const expensesPath = collection(db, 'artifacts', appId, 'public', 'data', 'expenses');

    setIsSyncing(true);

    const unsubTrips = onSnapshot(tripsPath, (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setEntries(data);
      setIsSyncing(false);
    }, (err) => console.error("Error en trips:", err));

    const unsubExpenses = onSnapshot(expensesPath, (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setExpenses(data);
    }, (err) => console.error("Error en expenses:", err));

    return () => {
      unsubTrips();
      unsubExpenses();
    };
  }, [user]);

  // --- Lógica de Formulario ---
  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onloadend = () => setExpReceipt(reader.result);
    reader.readAsDataURL(file);
  };

  const addTrip = async (e) => {
    e.preventDefault();
    if (!user || !routeName.trim()) return;
    
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'trips'), {
        routeName,
        destination,
        date: tripDate,
        startTime: startTime || null,
        endTime: endTime || null,
        timestamp: new Date().getTime()
      });
      setRouteName(''); setStartTime(''); setEndTime('');
    } catch (err) {
      console.error("Error guardando viaje:", err);
    }
  };

  const addExpense = async (e) => {
    e.preventDefault();
    if (!user || !expDescription.trim() || !expAmount) return;

    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), {
        description: expDescription,
        amount: parseFloat(expAmount),
        category: expCategory,
        date: expDate,
        receipt: expReceipt,
        timestamp: new Date().getTime()
      });
      setExpDescription(''); setExpAmount(''); setExpReceipt(null);
    } catch (err) {
      console.error("Error guardando gasto:", err);
    }
  };

  const deleteItem = async (id, type) => {
    if (!user) return;
    const collectionName = type === 'trip' ? 'trips' : 'expenses';
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionName, id));
    } catch (err) {
      console.error("Error eliminando:", err);
    }
  };

  // --- Filtrado Local ---
  const filteredTrips = useMemo(() => {
    return entries.filter(e => {
      const d = new Date(e.date + "T00:00:00");
      return d.getMonth() === viewMonth.getMonth() && d.getFullYear() === viewMonth.getFullYear();
    }).sort((a, b) => b.date.localeCompare(a.date));
  }, [entries, viewMonth]);

  const filteredExpenses = useMemo(() => {
    return expenses.filter(e => {
      const d = new Date(e.date + "T00:00:00");
      return d.getMonth() === viewMonth.getMonth() && d.getFullYear() === viewMonth.getFullYear();
    }).sort((a, b) => b.date.localeCompare(a.date));
  }, [expenses, viewMonth]);

  const totalMonthlyExpenses = filteredExpenses.reduce((acc, curr) => acc + curr.amount, 0);

  // --- Funciones de Exportación ---
  const exportToPDF = async () => {
    const loaded = await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
    const tableLoaded = await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js');
    if (!loaded || !tableLoaded) return;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const title = `Reporte_${viewMonth.toLocaleString('es-ES', { month: 'long' })}_${viewMonth.getFullYear()}`;

    doc.setFontSize(18);
    doc.text(`Control Logístico - ${title.replace('_', ' ')}`, 14, 20);
    
    doc.autoTable({
      startY: 30,
      head: [['Fecha', 'Ruta', 'Destino', 'Entrada', 'Salida']],
      body: filteredTrips.map(t => [t.date, t.routeName, t.destination, t.startTime || '-', t.endTime || '-']),
    });

    const nextY = doc.lastAutoTable.finalY + 15;
    doc.text("Resumen de Gastos", 14, nextY);
    doc.autoTable({
      startY: nextY + 5,
      head: [['Fecha', 'Descripción', 'Categoría', 'Monto']],
      body: filteredExpenses.map(ex => [ex.date, ex.description, ex.category, `$${ex.amount.toLocaleString()}`]),
      foot: [['', '', 'TOTAL', `$${totalMonthlyExpenses.toLocaleString()}`]]
    });

    doc.save(`${title}.pdf`);
  };

  if (loadingAuth) {
    return (
      <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-6 text-center">
        <Loader2 className="animate-spin text-indigo-600 mb-4" size={50} />
        <h2 className="text-xl font-bold text-slate-700">Iniciando Base de Datos</h2>
        <p className="text-slate-400">Preparando conexión segura con la nube...</p>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-100 text-slate-900 font-sans pb-10">
      {/* Navbar con selector de mes */}
      <nav className="bg-indigo-950 text-white p-4 sticky top-0 z-40 shadow-xl">
        <div className="max-w-6xl mx-auto flex items-center justify-between">
          <div className="flex items-center gap-2">
            <TrendingUp className="text-indigo-400" />
            <h1 className="font-bold text-lg hidden sm:block">LogiTrack Cloud</h1>
          </div>
          <div className="flex items-center gap-2 bg-white/10 p-1 rounded-2xl border border-white/10">
            <button onClick={() => setViewMonth(new Date(viewMonth.getFullYear(), viewMonth.getMonth() - 1, 1))} className="p-2 hover:bg-white/10 rounded-xl transition-colors"><ChevronLeft size={20}/></button>
            <span className="font-bold text-xs uppercase px-4 min-w-[130px] text-center tracking-widest">{viewMonth.toLocaleString('es-ES', { month: 'long', year: 'numeric' })}</span>
            <button onClick={() => setViewMonth(new Date(viewMonth.getFullYear(), viewMonth.getMonth() + 1, 1))} className="p-2 hover:bg-white/10 rounded-xl transition-colors"><ChevronRight size={20}/></button>
          </div>
          <div className="flex items-center gap-2 text-[10px] font-bold text-emerald-400 bg-emerald-400/10 px-3 py-1.5 rounded-full border border-emerald-400/20">
            <div className="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-pulse"></div>
            CLOUD OK
          </div>
        </div>
      </nav>

      <main className="max-w-6xl mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        {/* Lado Izquierdo: Formularios */}
        <div className="lg:col-span-4 space-y-6">
          <div className="bg-white p-1.5 rounded-2xl shadow-sm border border-slate-200 flex">
            <button onClick={() => setActiveTab('trips')} className={`flex-1 flex items-center justify-center gap-2 py-3 rounded-xl font-bold transition-all ${activeTab === 'trips' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-50'}`}><MapPin size={18} /> Rutas</button>
            <button onClick={() => setActiveTab('expenses')} className={`flex-1 flex items-center justify-center gap-2 py-3 rounded-xl font-bold transition-all ${activeTab === 'expenses' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-50'}`}><CreditCard size={18} /> Gastos</button>
          </div>

          <div className="bg-white rounded-[2rem] shadow-2xl border border-slate-200 overflow-hidden">
            <div className={`p-5 text-white flex items-center gap-3 ${activeTab === 'trips' ? 'bg-indigo-600' : 'bg-emerald-600'}`}>
              {activeTab === 'trips' ? <FileText size={20}/> : <Wallet size={20}/>}
              <h2 className="font-bold tracking-tight">Nuevo Registro Cloud</h2>
            </div>
            
            <div className="p-6">
              {activeTab === 'trips' ? (
                <form onSubmit={addTrip} className="space-y-4">
                  <input type="text" placeholder="Nombre de Ruta" value={routeName} onChange={e => setRouteName(e.target.value)} className="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all font-medium" required />
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="text-[10px] font-black text-slate-400 uppercase ml-2">Entrada</label>
                      <input type="time" value={startTime} onChange={e => setStartTime(e.target.value)} className="w-full mt-1 p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none" />
                    </div>
                    <div>
                      <label className="text-[10px] font-black text-slate-400 uppercase ml-2">Salida</label>
                      <input type="time" value={endTime} onChange={e => setEndTime(e.target.value)} className="w-full mt-1 p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none" />
                    </div>
                  </div>
                  <input type="date" value={tripDate} onChange={e => setTripDate(e.target.value)} className="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none" required />
                  <div className="grid grid-cols-2 gap-3">
                    <button type="button" onClick={() => setDestination('Santiago')} className={`p-4 rounded-2xl border-2 font-black transition-all text-xs tracking-widest ${destination === 'Santiago' ? 'border-green-500 bg-green-50 text-green-700' : 'border-slate-100 text-slate-300'}`}>SANTIAGO</button>
                    <button type="button" onClick={() => setDestination('Región')} className={`p-4 rounded-2xl border-2 font-black transition-all text-xs tracking-widest ${destination === 'Región' ? 'border-yellow-500 bg-yellow-50 text-yellow-700' : 'border-slate-100 text-slate-300'}`}>REGIÓN</button>
                  </div>
                  <button type="submit" className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-black py-4 rounded-2xl shadow-xl shadow-indigo-100 transition-all flex items-center justify-center gap-2 transform active:scale-95"><Plus size={20}/> GUARDAR EN CLOUD</button>
                </form>
              ) : (
                <form onSubmit={addExpense} className="space-y-4">
                  <input type="text" placeholder="¿Qué compraste?" value={expDescription} onChange={e => setExpDescription(e.target.value)} className="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-emerald-500 transition-all font-medium" required />
                  <div className="flex gap-3">
                    <div className="relative flex-1">
                      <span className="absolute left-4 top-4 text-slate-400 font-bold">$</span>
                      <input type="number" placeholder="Monto" value={expAmount} onChange={e => setExpAmount(e.target.value)} className="w-full p-4 pl-8 bg-slate-50 border border-slate-200 rounded-2xl outline-none" required />
                    </div>
                    <select value={expCategory} onChange={e => setExpCategory(e.target.value)} className="p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none font-bold text-slate-600">
                      <option>Peaje</option><option>Bencina</option><option>Viáticos</option><option>Otro</option>
                    </select>
                  </div>
                  <input type="date" value={expDate} onChange={e => setExpDate(e.target.value)} className="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none" required />
                  
                  <div className="relative group">
                    <input type="file" accept="image/*" ref={fileInputRef} className="hidden" onChange={handleImageUpload} />
                    <button type="button" onClick={() => fileInputRef.current.click()} className={`w-full p-4 border-2 border-dashed rounded-2xl flex items-center justify-center gap-3 transition-all ${expReceipt ? 'border-emerald-500 bg-emerald-50 text-emerald-700 font-bold' : 'border-slate-200 text-slate-400 hover:border-emerald-400'}`}>
                      {expReceipt ? <CheckCircle2 className="text-emerald-500" size={20}/> : <Camera size={20}/>}
                      {expReceipt ? 'Comprobante Listo' : 'Subir Ticket (Opcional)'}
                    </button>
                    {expReceipt && (
                      <button type="button" onClick={() => setExpReceipt(null)} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-lg hover:bg-red-600 transition-colors"><X size={14}/></button>
                    )}
                  </div>

                  <button type="submit" className="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-black py-4 rounded-2xl shadow-xl shadow-emerald-100 transition-all flex items-center justify-center gap-2 transform active:scale-95"><Receipt size={20}/> REGISTRAR GASTO</button>
                </form>
              )}
            </div>
          </div>
          
          <div className="flex gap-3">
            <button onClick={exportToPDF} className="flex-1 bg-white p-4 rounded-2xl border border-slate-200 text-slate-600 font-black text-xs flex items-center justify-center gap-2 hover:bg-indigo-50 hover:text-indigo-600 transition-all"><FileDown size={18}/> PDF</button>
            <button onClick={() => alert("Función: Abre el historial y toma captura de pantalla para compartir como imagen.")} className="flex-1 bg-white p-4 rounded-2xl border border-slate-200 text-slate-600 font-black text-xs flex items-center justify-center gap-2 hover:bg-amber-50 hover:text-amber-600 transition-all"><ImageIcon size={18}/> IMAGEN</button>
          </div>
        </div>

        {/* Lado Derecho: Reportes y Lista */}
        <div className="lg:col-span-8 space-y-6" ref={reportRef}>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
            <div className="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-200 group hover:border-green-500 transition-all">
              <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Santiago</span>
              <p className="text-4xl font-black text-green-600 mt-1">{filteredTrips.filter(e => e.destination === 'Santiago').length}</p>
            </div>
            <div className="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-200 group hover:border-yellow-500 transition-all">
              <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Región</span>
              <p className="text-4xl font-black text-yellow-600 mt-1">{filteredTrips.filter(e => e.destination === 'Región').length}</p>
            </div>
            <div className="bg-indigo-900 p-6 rounded-[2rem] shadow-2xl text-white">
              <span className="text-[10px] font-black text-indigo-300 uppercase tracking-widest">Gastos Totales</span>
              <p className="text-4xl font-black mt-1">${totalMonthlyExpenses.toLocaleString()}</p>
            </div>
          </div>

          <div className="bg-white rounded-[2.5rem] shadow-sm border border-slate-200 overflow-hidden">
            <div className="p-6 bg-slate-50/50 border-b flex items-center justify-between">
              <h3 className="font-black text-slate-700 flex items-center gap-2 uppercase tracking-tighter italic"><CalendarIcon size={20} className="text-indigo-600" /> Historial Sincronizado</h3>
              <span className="text-[10px] font-black bg-indigo-600 text-white px-4 py-2 rounded-full shadow-lg shadow-indigo-200">{filteredTrips.length + filteredExpenses.length} REGISTROS</span>
            </div>

            <div className="p-4 space-y-3">
              {isSyncing ? (
                <div className="p-20 text-center flex flex-col items-center">
                  <Loader2 className="animate-spin text-slate-200 mb-2" size={40} />
                  <p className="text-slate-300 font-bold uppercase text-xs tracking-widest">Sincronizando...</p>
                </div>
              ) : filteredTrips.length === 0 && filteredExpenses.length === 0 ? (
                <div className="p-20 text-center text-slate-300 font-bold uppercase tracking-widest text-sm italic">Sin movimientos registrados en la nube</div>
              ) : (
                <>
                  {/* Bloque Viajes */}
                  {filteredTrips.map(trip => (
                    <div key={trip.id} className={`p-5 rounded-[1.5rem] border-2 flex items-center justify-between transition-all hover:scale-[1.01] ${trip.destination === 'Santiago' ? 'bg-green-500/5 border-green-500/30' : 'bg-yellow-500/5 border-yellow-500/30'}`}>
